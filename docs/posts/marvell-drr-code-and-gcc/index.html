<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Marvell DDR Code and GCC | Adrian's Blog</title><meta name=keywords content><meta name=description content="I have a SolidRun MACCHIATObin Single Shot, and you can build and use UEFI on it. This involves compiling code from a variety of repos, one of those being mv-ddr-marvell. To do this, I made a git repo full of helper scripts. I don&rsquo;t use the dev board much anymore, and it is mostly there to possibly help others build the collection of firmware that results in the image that I burn onto a microSD card."><meta name=author content="Adrian Lucrèce Céleste"><link rel=canonical href=https://blog.adrianlucrececeleste.page/posts/marvell-drr-code-and-gcc/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.adrianlucrececeleste.page/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.adrianlucrececeleste.page/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.adrianlucrececeleste.page/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.adrianlucrececeleste.page/apple-touch-icon.png><link rel=mask-icon href=https://blog.adrianlucrececeleste.page/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Marvell DDR Code and GCC"><meta property="og:description" content="I have a SolidRun MACCHIATObin Single Shot, and you can build and use UEFI on it. This involves compiling code from a variety of repos, one of those being mv-ddr-marvell. To do this, I made a git repo full of helper scripts. I don&rsquo;t use the dev board much anymore, and it is mostly there to possibly help others build the collection of firmware that results in the image that I burn onto a microSD card."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.adrianlucrececeleste.page/posts/marvell-drr-code-and-gcc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-20T15:42:39-04:00"><meta property="article:modified_time" content="2023-07-20T15:42:39-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Marvell DDR Code and GCC"><meta name=twitter:description content="I have a SolidRun MACCHIATObin Single Shot, and you can build and use UEFI on it. This involves compiling code from a variety of repos, one of those being mv-ddr-marvell. To do this, I made a git repo full of helper scripts. I don&rsquo;t use the dev board much anymore, and it is mostly there to possibly help others build the collection of firmware that results in the image that I burn onto a microSD card."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.adrianlucrececeleste.page/posts/"},{"@type":"ListItem","position":3,"name":"Marvell DDR Code and GCC","item":"https://blog.adrianlucrececeleste.page/posts/marvell-drr-code-and-gcc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Marvell DDR Code and GCC","name":"Marvell DDR Code and GCC","description":"I have a SolidRun MACCHIATObin Single Shot, and you can build and use UEFI on it. This involves compiling code from a variety of repos, one of those being mv-ddr-marvell. To do this, I made a git repo full of helper scripts. I don\u0026rsquo;t use the dev board much anymore, and it is mostly there to possibly help others build the collection of firmware that results in the image that I burn onto a microSD card.","keywords":[],"articleBody":"I have a SolidRun MACCHIATObin Single Shot, and you can build and use UEFI on it. This involves compiling code from a variety of repos, one of those being mv-ddr-marvell. To do this, I made a git repo full of helper scripts. I don’t use the dev board much anymore, and it is mostly there to possibly help others build the collection of firmware that results in the image that I burn onto a microSD card.\nThe Problem So, I wouldn’t be making a blog post on a blog I haven’t posted on for years if I hadn’t ran into some issue, and I did, between the aformentioned Marvell DDR code and recent versions of GCC (\u003e=12). One of the last steps of building the firmware is building TrustedFirmware-A, and getting some Marvell Binaries, and that DRR code and throwing it all together in some way (I don’t claim to understand the build process super well). My build environment is a Debian 12 VM running on Hyper V on the Windows Dev Kit 2023. So what exactly happens? This happens:\n$ bash tfa.sh make: Entering directory '/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a' Building DRAM driver CC apn806/mv_ddr_plat.c CC apn806/mv_ddr_static.c CC apn806/mv_ddr_validate.c CC ddr_init.c CC ddr3_init.c CC ddr3_training_db.c CC mv_ddr_build_message.c CC mv_ddr_common.c CC mv_ddr_spd.c CC mv_ddr_mrs.c CC mv_ddr_topology.c CC mv_ddr4_training_db.c CC drivers/mv_ddr_mc6.c CC drivers/mv_ddr_xor_v2.c CC ddr3_debug.c CC ddr3_training.c CC ddr3_training_bist.c CC ddr3_training_centralization.c CC ddr3_training_hw_algo.c CC ddr3_training_ip_engine.c CC ddr3_training_leveling.c In file included from mv_ddr_atf_wrapper.h:232, from ddr3_init.h:105, from ddr3_training_leveling.c:98: In function ‘mmio_read_32’, inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1980:5: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:46:16: error: array subscript 0 is outside array bounds of ‘volatile uint32_t[0]’ {aka ‘volatile unsigned int[]’} [-Werror=array-bounds] 46 | return *(volatile uint32_t*)addr; | ^~~~~~~~~~~~~~~~~~~~~~~~~ In function ‘mmio_read_64’, inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1978:5: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:56:16: error: array subscript 0 is outside array bounds of ‘volatile uint64_t[0]’ {aka ‘volatile long unsigned int[]’} [-Werror=array-bounds] 56 | return *(volatile uint64_t*)addr; | ^~~~~~~~~~~~~~~~~~~~~~~~~ cc1: all warnings being treated as errors make[1]: *** [Makefile:473: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/ble/ddr3_training_leveling.o] Error 1 make: *** [plat/marvell/armada/a8k/common/ble/ble.mk:35: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/ble/mv_ddr_lib.a] Error 2 make: Leaving directory '/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a' cp: cannot stat 'trusted-firmware-a/build/a80x0_mcbin/release/flash-image.bin': No such file or directory tfa.sh is one of the helper scripts, and its contents are:\n#!/usr/bin/env bash BDIR=e2b cd ${BDIR} export WORKSPACE=$PWD export PACKAGES_PATH=$PWD/edk2:$PWD/edk2-platforms:$PWD/edk2-non-osi make -C trusted-firmware-a \\ PLAT=a80x0_mcbin \\ MV_DDR_PATH=$PWD/mv-ddr-marvell \\ SCP_BL2=$PWD/binaries/mrvl_scp_bl2.img \\ BL33=$PWD/Build/Armada80x0McBin-AARCH64/RELEASE_GCC5/FV/ARMADA_EFI.fd \\ all fip mrvl_flash It sets a variable for our build directory, goes to that directory, and some others that I believe the build process expects, and then kicks off make for TF-A.\nTo drill down to the error more specifically:\nIn function ‘mmio_read_32’, inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1980:5: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:46:16: error: array subscript 0 is outside array bounds of ‘volatile uint32_t[0]’ {aka ‘volatile unsigned int[]’} [-Werror=array-bounds] 46 | return *(volatile uint32_t*)addr; | ^~~~~~~~~~~~~~~~~~~~~~~~~ In function ‘mmio_read_64’, inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1978:5: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:56:16: error: array subscript 0 is outside array bounds of ‘volatile uint64_t[0]’ {aka ‘volatile long unsigned int[]’} [-Werror=array-bounds] 56 | return *(volatile uint64_t*)addr; | ^~~~~~~~~~~~~~~~~~~~~~~~~ gcc (Debian 12.2.0-14) 12.2.0 doesn’t care for how Marvell decided to handle this array code, and I don’t blame it, I’m not a firmware developer, but it looks a bit…weird to me.\nThe “Solution” This started my quest of finding a version of gcc that would compile this code and not complain, and I started with gcc 7.5.0, but I eventually ended up finding out that gcc 11.4.0 is the latest version (as of the time I tried) that copmiled this code. After some googling, I found out how to declare a toolchain for TF-A.\nPrep Before going on to compiling gcc or binutils, you’ll want to make sure you have some stuff installed:\n$ sudo apt install build-essential acpica-tools device-tree-compiler uuid-dev libssl-dev gcc-aarch64-linux-gnu texinfo bison help2man --install-recommends -y Compiling GCC This is easy enough, there’s documentation on how to build it from source, and so I followed it.\nalc@devvm:~/toolchain-src/$ wget https://ftp.gnu.org/gnu/gcc/gcc-11.4.0/gcc-11.4.0.tar.gz alc@devvm:~/toolchain-src/$ tar xvf gcc-11.4.0.tar.gz alc@devvm:~/toolchain-src/$ cd gcc-11.4.0 alc@devvm:~/toolchain-src/gcc-11.4.0$ ./contrib/download_prerequisites alc@devvm:~/toolchain-src/$ cd .. alc@devvm:~/toolchain-src/$ mkdir objdir alc@devvm:~/toolchain-src/$ cd objdir alc@devvm:~/toolchain-src/objdir$ $PWD/../gcc-11.4.0/configure --prefix=$HOME/buildroot/11.4.0 --enable-languages=c,c++,lto --enable-lto --disable-nls --disable-libquadmath --disable-libquadmath-support --enable-default-pie --disable-werror --enable-linker-build-id alc@devvm:~/toolchain-src/objdir$ make -j5 alc@devvm:~/toolchain-src/objdir$ make install Actually building gcc on my system takes a bit over half an hour, and I’ll admit some of the enable/disable statements here aren’t exactly scientific, but it’s what made the process work for me.\nCompiling Binutils This one is even more straight forward, and we need this for things like ld and ar.\nalc@devvm:~/toolchain-src$ wget https://ftp.gnu.org/gnu/binutils/binutils-2.40.tar.xz alc@devvm:~/toolchain-src$ tar xvf binutils-2.40.tar.xz alc@devvm:~/toolchain-src$ cd binutils-2.40 alc@devvm:~/toolchain-src/binutils-2.40$ ./configure --prefix=$HOME/buildroot/11.4.0/ ./configure --prefix=$HOME/buildroot/11.4.0/ --enable-lto --enable-year2038 --with-pic --enable-deterministic-archives alc@devvm:~/toolchain-src/binutils-2.40$ make -j5 alc@devvm:~/toolchain-src/binutils-2.40$ make install Modifying tfa.sh As seen as in the TF-A documentation, we need to add export CROSS_COMPILE=/bin/aarch64-none-elf- to tfa.sh so that it will use our version of gcc and binutils, although I found I needed something more like export CROSS_COMPILE=/bin/, for me tfa.sh ended up looking like this:\n#!/usr/bin/env bash BDIR=e2b cd ${BDIR} export WORKSPACE=$PWD export PACKAGES_PATH=$PWD/edk2:$PWD/edk2-platforms:$PWD/edk2-non-osi export CROSS_COMPILE=\"$HOME/buildroot/11.4.0/bin/\" make -C trusted-firmware-a \\ PLAT=a80x0_mcbin \\ MV_DDR_PATH=$PWD/mv-ddr-marvell \\ SCP_BL2=$PWD/binaries/mrvl_scp_bl2.img \\ BL33=$PWD/Build/Armada80x0McBin-AARCH64/RELEASE_GCC5/FV/ARMADA_EFI.fd \\ all fip mrvl_flash cp trusted-firmware-a/build/a80x0_mcbin/release/flash-image.bin uefi-mcbin-spi.bin now if we run tfa.sh the final bit of output we get is:\nBuilt /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/bl31.bin successfully OD /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/bl31/bl31.dump HOSTCC fiptool.c HOSTCC tbbr_config.c HOSTLD fiptool Built fiptool successfully Trusted Boot Firmware BL2: offset=0xD8, size=0x5321, cmdline=\"--tb-fw\" SCP Firmware SCP_BL2: offset=0x53F9, size=0x28A2C, cmdline=\"--scp-fw\" EL3 Runtime Firmware BL31: offset=0x2DE25, size=0xD253, cmdline=\"--soc-fw\" Non-Trusted Firmware BL33: offset=0x3B078, size=0x200000, cmdline=\"--nt-fw\" Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/fip.bin successfully Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/boot-image.bin successfully make[1]: Nothing to be done for 'all'. Building flash image Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/flash-image.bin successfully make: Leaving directory '/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a' Hurray, e2b/uefi-mcbin-spi.bin is what we wanted in the end, and everything builds.\n","wordCount":"903","inLanguage":"en","datePublished":"2023-07-20T15:42:39-04:00","dateModified":"2023-07-20T15:42:39-04:00","author":{"@type":"Person","name":"Adrian Lucrèce Céleste"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.adrianlucrececeleste.page/posts/marvell-drr-code-and-gcc/"},"publisher":{"@type":"Organization","name":"Adrian's Blog","logo":{"@type":"ImageObject","url":"https://blog.adrianlucrececeleste.page/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.adrianlucrececeleste.page accesskey=h title="Adrian's Blog (Alt + H)">Adrian's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.adrianlucrececeleste.page/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://blog.adrianlucrececeleste.page/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Marvell DDR Code and GCC</h1><div class=post-meta><span title='2023-07-20 15:42:39 -0400 EDT'>July 20, 2023</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Adrian Lucrèce Céleste</div></header><div class=post-content><p>I have a SolidRun MACCHIATObin Single Shot, and you can build and use UEFI on it. This involves compiling code from a variety of repos, one of those being <a href=https://github.com/MarvellEmbeddedProcessors/mv-ddr-marvell>mv-ddr-marvell</a>. To do this, I made a <a href=https://github.com/AdrianKoshka/macc-uefi-build-script>git repo</a> full of helper scripts. I don&rsquo;t use the dev board much anymore, and it is mostly there to possibly help others build the collection of firmware that results in the image that I burn onto a microSD card.</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>So, I wouldn&rsquo;t be making a blog post on a blog I haven&rsquo;t posted on for years if I hadn&rsquo;t ran into some issue, and I did, between the aformentioned <a href=https://github.com/MarvellEmbeddedProcessors/mv-ddr-marvell>Marvell DDR code</a> and recent versions of GCC (>=12). One of the last steps of building the firmware is building <a href=https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git>TrustedFirmware-A</a>, and getting some <a href=https://github.com/MarvellEmbeddedProcessors/binaries-marvell/tree/binaries-marvell-armada-SDK10.0.1.0>Marvell Binaries</a>, and that <a href=https://github.com/MarvellEmbeddedProcessors/mv-ddr-marvell.git>DRR code</a> and throwing it all together in some way (I don&rsquo;t claim to understand the build process super well). My build environment is a Debian 12 VM running on Hyper V on the <a href=https://www.microsoft.com/en-us/d/windows-dev-kit-2023/94K0P67W7581>Windows Dev Kit 2023</a>. So what exactly happens? This happens:</p><pre tabindex=0><code>$ bash tfa.sh 
make: Entering directory &#39;/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a&#39;

Building DRAM driver
  CC      apn806/mv_ddr_plat.c
  CC      apn806/mv_ddr_static.c
  CC      apn806/mv_ddr_validate.c
  CC      ddr_init.c
  CC      ddr3_init.c
  CC      ddr3_training_db.c
  CC      mv_ddr_build_message.c
  CC      mv_ddr_common.c
  CC      mv_ddr_spd.c
  CC      mv_ddr_mrs.c
  CC      mv_ddr_topology.c
  CC      mv_ddr4_training_db.c
  CC      drivers/mv_ddr_mc6.c
  CC      drivers/mv_ddr_xor_v2.c
  CC      ddr3_debug.c
  CC      ddr3_training.c
  CC      ddr3_training_bist.c
  CC      ddr3_training_centralization.c
  CC      ddr3_training_hw_algo.c
  CC      ddr3_training_ip_engine.c
  CC      ddr3_training_leveling.c
In file included from mv_ddr_atf_wrapper.h:232,
                 from ddr3_init.h:105,
                 from ddr3_training_leveling.c:98:
In function ‘mmio_read_32’,
    inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1980:5:
/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:46:16: error: array subscript 0 is outside array bounds of ‘volatile uint32_t[0]’ {aka ‘volatile unsigned int[]’} [-Werror=array-bounds]
   46 |         return *(volatile uint32_t*)addr;
      |                ^~~~~~~~~~~~~~~~~~~~~~~~~
In function ‘mmio_read_64’,
    inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1978:5:
/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:56:16: error: array subscript 0 is outside array bounds of ‘volatile uint64_t[0]’ {aka ‘volatile long unsigned int[]’} [-Werror=array-bounds]
   56 |         return *(volatile uint64_t*)addr;
      |                ^~~~~~~~~~~~~~~~~~~~~~~~~
cc1: all warnings being treated as errors
make[1]: *** [Makefile:473: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/ble/ddr3_training_leveling.o] Error 1
make: *** [plat/marvell/armada/a8k/common/ble/ble.mk:35: /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/ble/mv_ddr_lib.a] Error 2
make: Leaving directory &#39;/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a&#39;
cp: cannot stat &#39;trusted-firmware-a/build/a80x0_mcbin/release/flash-image.bin&#39;: No such file or directory
</code></pre><p><code>tfa.sh</code> is one of the helper scripts, and its contents are:</p><pre tabindex=0><code>#!/usr/bin/env bash
BDIR=e2b

cd ${BDIR}
export WORKSPACE=$PWD
export PACKAGES_PATH=$PWD/edk2:$PWD/edk2-platforms:$PWD/edk2-non-osi

make -C trusted-firmware-a \
        PLAT=a80x0_mcbin \
        MV_DDR_PATH=$PWD/mv-ddr-marvell \
        SCP_BL2=$PWD/binaries/mrvl_scp_bl2.img \
        BL33=$PWD/Build/Armada80x0McBin-AARCH64/RELEASE_GCC5/FV/ARMADA_EFI.fd \
        all fip mrvl_flash
</code></pre><p>It sets a variable for our build directory, goes to that directory, and some others that I believe the build process expects, and then kicks off <code>make</code> for TF-A.</p><p>To drill down to the error more specifically:</p><pre tabindex=0><code>In function ‘mmio_read_32’,
    inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1980:5:
/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:46:16: error: array subscript 0 is outside array bounds of ‘volatile uint32_t[0]’ {aka ‘volatile unsigned int[]’} [-Werror=array-bounds]
   46 |         return *(volatile uint32_t*)addr;
      |                ^~~~~~~~~~~~~~~~~~~~~~~~~
In function ‘mmio_read_64’,
    inlined from ‘mv_ddr_rl_dqs_burst’ at ddr3_training_leveling.c:1978:5:
/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/include/lib/mmio.h:56:16: error: array subscript 0 is outside array bounds of ‘volatile uint64_t[0]’ {aka ‘volatile long unsigned int[]’} [-Werror=array-bounds]
   56 |         return *(volatile uint64_t*)addr;
      |                ^~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre><p><code>gcc (Debian 12.2.0-14) 12.2.0</code> doesn&rsquo;t care for how Marvell decided to handle this array code, and I don&rsquo;t blame it, I&rsquo;m not a firmware developer, but it looks a bit&mldr;weird to me.</p><h2 id=the-solution>The &ldquo;Solution&rdquo;<a hidden class=anchor aria-hidden=true href=#the-solution>#</a></h2><p>This started my quest of finding a version of <code>gcc</code> that would compile this code and not complain, and I started with <code>gcc</code> 7.5.0, but I eventually ended up finding out that <code>gcc</code> 11.4.0 is the latest version (as of the time I tried) that copmiled this code. After some googling, I found out how to <a href=https://trustedfirmware-a.readthedocs.io/en/latest/getting_started/initial-build.html>declare a toolchain</a> for TF-A.</p><h3 id=prep>Prep<a hidden class=anchor aria-hidden=true href=#prep>#</a></h3><p>Before going on to compiling <code>gcc</code> or <code>binutils</code>, you&rsquo;ll want to make sure you have some stuff installed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo apt install build-essential acpica-tools device-tree-compiler uuid-dev libssl-dev gcc-aarch64-linux-gnu texinfo bison help2man --install-recommends -y
</span></span></code></pre></div><h3 id=compiling-gcc>Compiling GCC<a hidden class=anchor aria-hidden=true href=#compiling-gcc>#</a></h3><p>This is easy enough, <a href=https://gcc.gnu.org/wiki/InstallingGCC>there&rsquo;s documentation</a> on how to build it from source, and so I followed it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>alc@devvm:~/toolchain-src/$ wget https://ftp.gnu.org/gnu/gcc/gcc-11.4.0/gcc-11.4.0.tar.gz
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/$ tar xvf gcc-11.4.0.tar.gz
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/$ cd gcc-11.4.0
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/gcc-11.4.0$ ./contrib/download_prerequisites
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/$ cd ..
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/$ mkdir objdir
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/$ cd objdir
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/objdir$ $PWD/../gcc-11.4.0/configure --prefix<span style=color:#f92672>=</span>$HOME/buildroot/11.4.0 --enable-languages<span style=color:#f92672>=</span>c,c++,lto --enable-lto --disable-nls --disable-libquadmath --disable-libquadmath-support --enable-default-pie --disable-werror --enable-linker-build-id
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/objdir$ make -j5
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/objdir$ make install
</span></span></code></pre></div><p>Actually building <code>gcc</code> on my system takes a bit over half an hour, and I&rsquo;ll admit some of the enable/disable statements here aren&rsquo;t exactly scientific, but it&rsquo;s what made the process work for me.</p><h3 id=compiling-binutils>Compiling Binutils<a hidden class=anchor aria-hidden=true href=#compiling-binutils>#</a></h3><p>This one is even more straight forward, and we need this for things like <code>ld</code> and <code>ar</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>alc@devvm:~/toolchain-src$ wget https://ftp.gnu.org/gnu/binutils/binutils-2.40.tar.xz
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src$ tar xvf binutils-2.40.tar.xz
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src$ cd binutils-2.40
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/binutils-2.40$ ./configure --prefix<span style=color:#f92672>=</span>$HOME/buildroot/11.4.0/ ./configure --prefix<span style=color:#f92672>=</span>$HOME/buildroot/11.4.0/ --enable-lto --enable-year2038 --with-pic --enable-deterministic-archives
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/binutils-2.40$ make -j5
</span></span><span style=display:flex><span>alc@devvm:~/toolchain-src/binutils-2.40$ make install
</span></span></code></pre></div><h3 id=modifying-tfash>Modifying <code>tfa.sh</code><a hidden class=anchor aria-hidden=true href=#modifying-tfash>#</a></h3><p>As seen as in the <a href=https://trustedfirmware-a.readthedocs.io/en/latest/getting_started/initial-build.html>TF-A documentation</a>, we need to add <code>export CROSS_COMPILE=&lt;path-to-aarch64-gcc>/bin/aarch64-none-elf-</code> to <code>tfa.sh</code> so that it will use our version of <code>gcc</code> and binutils, although I found I needed something more like <code>export CROSS_COMPILE=&lt;path-to-aarch64-gcc>/bin/</code>, for me <code>tfa.sh</code> ended up looking like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>BDIR<span style=color:#f92672>=</span>e2b
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd <span style=color:#e6db74>${</span>BDIR<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>export WORKSPACE<span style=color:#f92672>=</span>$PWD
</span></span><span style=display:flex><span>export PACKAGES_PATH<span style=color:#f92672>=</span>$PWD/edk2:$PWD/edk2-platforms:$PWD/edk2-non-osi
</span></span><span style=display:flex><span>export CROSS_COMPILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/buildroot/11.4.0/bin/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make -C trusted-firmware-a <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        PLAT<span style=color:#f92672>=</span>a80x0_mcbin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        MV_DDR_PATH<span style=color:#f92672>=</span>$PWD/mv-ddr-marvell <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        SCP_BL2<span style=color:#f92672>=</span>$PWD/binaries/mrvl_scp_bl2.img <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        BL33<span style=color:#f92672>=</span>$PWD/Build/Armada80x0McBin-AARCH64/RELEASE_GCC5/FV/ARMADA_EFI.fd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        all fip mrvl_flash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp trusted-firmware-a/build/a80x0_mcbin/release/flash-image.bin uefi-mcbin-spi.bin
</span></span></code></pre></div><p>now if we run <code>tfa.sh</code> the final bit of output we get is:</p><pre tabindex=0><code>Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/bl31.bin successfully

  OD      /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/bl31/bl31.dump
  HOSTCC  fiptool.c
  HOSTCC  tbbr_config.c
  HOSTLD  fiptool

Built fiptool successfully

Trusted Boot Firmware BL2: offset=0xD8, size=0x5321, cmdline=&#34;--tb-fw&#34;
SCP Firmware SCP_BL2: offset=0x53F9, size=0x28A2C, cmdline=&#34;--scp-fw&#34;
EL3 Runtime Firmware BL31: offset=0x2DE25, size=0xD253, cmdline=&#34;--soc-fw&#34;
Non-Trusted Firmware BL33: offset=0x3B078, size=0x200000, cmdline=&#34;--nt-fw&#34;

Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/fip.bin successfully


Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/boot-image.bin successfully

make[1]: Nothing to be done for &#39;all&#39;.

Building flash image

Built /home/alc/macc-uefi-build-script/e2b/trusted-firmware-a/build/a80x0_mcbin/release/flash-image.bin successfully

make: Leaving directory &#39;/home/alc/macc-uefi-build-script/e2b/trusted-firmware-a&#39;
</code></pre><p>Hurray, <code>e2b/uefi-mcbin-spi.bin</code> is what we wanted in the end, and everything builds.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.adrianlucrececeleste.page>Adrian's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>